#!/bin/bash

# üöÄ PRE-COMMIT AUTO-RESOLVER HOOK
# Se ejecuta autom√°ticamente antes de cada commit
# Resuelve conflictos de merge y simulaciones sin intervenci√≥n manual

echo "üõ°Ô∏è PRE-COMMIT AUTO-RESOLVER ACTIVADO"
echo "üîß Verificando y resolviendo problemas autom√°ticamente..."

# Verificar si estamos en Windows
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then
    # Windows - usar script batch
    if [ -f "scripts/auto-commit-resolver.bat" ]; then
        echo "ü™ü Windows detectado - ejecutando script batch..."
        cmd //c "scripts\\auto-commit-resolver.bat"
        RESOLVER_EXIT_CODE=$?
    else
        echo "‚ùå Script de resoluci√≥n no encontrado en scripts/auto-commit-resolver.bat"
        exit 1
    fi
else
    # Linux/Mac - usar script de PowerShell si est√° disponible
    if command -v pwsh >/dev/null 2>&1; then
        echo "üêß Linux/Mac con PowerShell Core - ejecutando script..."
        pwsh -ExecutionPolicy Bypass -File "scripts/auto-commit-resolver.ps1" auto-fix
        RESOLVER_EXIT_CODE=$?
    elif command -v powershell >/dev/null 2>&1; then
        echo "üêß Linux/Mac con PowerShell - ejecutando script..."
        powershell -ExecutionPolicy Bypass -File "scripts/auto-commit-resolver.ps1" auto-fix
        RESOLVER_EXIT_CODE=$?
    else
        echo "‚ùå PowerShell no disponible en este sistema"
        echo "üí° Instala PowerShell Core o usa Windows"
        exit 1
    fi
fi

# Verificar resultado del resolver
if [ $RESOLVER_EXIT_CODE -eq 0 ]; then
    echo "‚úÖ AUTO-RESOLVER COMPLETADO EXITOSAMENTE"
    echo "üéØ Continuando con commit..."
    
    # Ejecutar el hook anti-simulaci√≥n original
    if [ -f ".githooks/pre-commit" ]; then
        echo "üîç Ejecutando validaci√≥n anti-simulaci√≥n..."
        .githooks/pre-commit
        ANTI_SIMULATION_EXIT_CODE=$?
        
        if [ $ANTI_SIMULATION_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ VALIDACI√ìN ANTI-SIMULACI√ìN EXITOSA"
            echo "üè• COMMIT APROBADO PARA APLICACI√ìN M√âDICA"
            exit 0
        else
            echo "‚ùå VALIDACI√ìN ANTI-SIMULACI√ìN FALL√ì"
            echo "üîß El auto-resolver no pudo resolver todos los problemas"
            echo "üí° Ejecuta manualmente: scripts/auto-commit-resolver.bat"
            exit 1
        fi
    else
        echo "‚ö†Ô∏è Hook anti-simulaci√≥n no encontrado - continuando..."
        exit 0
    fi
else
    echo "‚ùå AUTO-RESOLVER FALL√ì"
    echo "üîß Revisa los errores y ejecuta manualmente:"
    echo "   Windows: scripts/auto-commit-resolver.bat"
    echo "   Linux/Mac: pwsh scripts/auto-commit-resolver.ps1 auto-fix"
    exit 1
fi
