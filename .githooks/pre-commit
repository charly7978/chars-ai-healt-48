#!/bin/bash

# Pre-commit hook para prevenir simulaciones en c√≥digo m√©dico
# TOLERANCIA CERO A SIMULACIONES

echo "üö´ VERIFICANDO C√ìDIGO M√âDICO - SIN SIMULACIONES PERMITIDAS"

# Verificar si hay archivos staged
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$staged_files" ]; then
    echo "‚úÖ No hay archivos de c√≥digo para verificar"
    exit 0
fi

echo "üìã Archivos a verificar:"
echo "$staged_files"

# Crear directorio temporal para verificaci√≥n
temp_dir=$(mktemp -d)
validation_results="$temp_dir/validation_results.json"

# Flag para tracking de violaciones cr√≠ticas
critical_violations=0
total_files=0

echo "üîç EJECUTANDO VALIDACI√ìN ANTI-SIMULACI√ìN..."

# Verificar cada archivo staged
while IFS= read -r file; do
    if [ -f "$file" ]; then
        total_files=$((total_files + 1))
        echo "   Verificando: $file"
        
        # Verificar Math.random()
        if grep -n "Math\.random()" "$file" > /dev/null; then
            echo "‚ùå CR√çTICO: Math.random() detectado en $file"
            grep -n "Math\.random()" "$file"
            critical_violations=$((critical_violations + 1))
        fi
        
        # Verificar keywords de simulaci√≥n
        simulation_patterns=("fake" "mock" "dummy" "simulate")
        for pattern in "${simulation_patterns[@]}"; do
            if grep -ni "$pattern" "$file" | grep -v "// REAL DATA\|// NO SIMULATION" > /dev/null; then
                echo "‚ùå CR√çTICO: Keyword de simulaci√≥n '$pattern' detectado en $file"
                grep -ni "$pattern" "$file" | grep -v "// REAL DATA\|// NO SIMULATION"
                critical_violations=$((critical_violations + 1))
            fi
        done
        
        # Verificar valores hardcodeados sospechosos
        if grep -n "bpm\s*[=:]\s*[0-9]" "$file" > /dev/null; then
            echo "‚ö†Ô∏è  ADVERTENCIA: Posible BPM hardcodeado en $file"
            grep -n "bpm\s*[=:]\s*[0-9]" "$file"
        fi
        
        if grep -n "spo2\?\s*[=:]\s*[0-9]" "$file" > /dev/null; then
            echo "‚ö†Ô∏è  ADVERTENCIA: Posible SpO2 hardcodeado en $file"
            grep -n "spo2\?\s*[=:]\s*[0-9]" "$file"
        fi
        
        # Verificar HeartRateDisplay obsoleto
        if grep -n "HeartRateDisplay" "$file" > /dev/null; then
            echo "‚ùå OBSOLETO: HeartRateDisplay detectado en $file - Use HeartRate from @/components/HeartRate"
            critical_violations=$((critical_violations + 1))
        fi
        
        # Verificar rangos fisiol√≥gicos
        bpm_values=$(grep -o "bpm\s*[=:]\s*[0-9]\+" "$file" | grep -o "[0-9]\+" || true)
        for bpm in $bpm_values; do
            if [ "$bpm" -lt 30 ] || [ "$bpm" -gt 200 ]; then
                echo "‚ùå CR√çTICO: BPM no fisiol√≥gico ($bpm) en $file"
                critical_violations=$((critical_violations + 1))
            fi
        done
        
        spo2_values=$(grep -o "spo2\?\s*[=:]\s*[0-9]\+" "$file" | grep -o "[0-9]\+" || true)
        for spo2 in $spo2_values; do
            if [ "$spo2" -lt 70 ] || [ "$spo2" -gt 100 ]; then
                echo "‚ùå CR√çTICO: SpO2 no fisiol√≥gico ($spo2) en $file"
                critical_violations=$((critical_violations + 1))
            fi
        done
    fi
done <<< "$staged_files"

# Verificar archivos de configuraci√≥n cr√≠ticos
config_files=("src/security/" "src/modules/vital-signs/" "src/modules/signal-processing/")
for config_dir in "${config_files[@]}"; do
    if [ -d "$config_dir" ]; then
        echo "üîí Verificando directorio cr√≠tico: $config_dir"
        if find "$config_dir" -name "*.ts" -o -name "*.tsx" | xargs grep -l "Math\.random\|fake\|mock\|dummy" > /dev/null 2>&1; then
            echo "‚ùå CR√çTICO: Simulaci√≥n detectada en directorio m√©dico cr√≠tico $config_dir"
            critical_violations=$((critical_violations + 1))
        fi
    fi
done

# Generar reporte final
echo ""
echo "üìä REPORTE DE VALIDACI√ìN M√âDICA"
echo "================================="
echo "Archivos verificados: $total_files"
echo "Violaciones cr√≠ticas: $critical_violations"

if [ $critical_violations -gt 0 ]; then
    echo ""
    echo "üö® COMMIT RECHAZADO - VIOLACIONES CR√çTICAS DETECTADAS"
    echo ""
    echo "RAZONES DEL RECHAZO:"
    echo "- Se detectaron $critical_violations violaciones cr√≠ticas"
    echo "- Uso de Math.random() en c√≥digo m√©dico"
    echo "- Keywords de simulaci√≥n en funciones cr√≠ticas"
    echo "- Valores no fisiol√≥gicos hardcodeados"
    echo "- Componentes obsoletos (HeartRateDisplay)"
    echo ""
    echo "ACCIONES REQUERIDAS:"
    echo "1. Reemplazar Math.random() con crypto.getRandomValues()"
    echo "2. Eliminar keywords de simulaci√≥n (fake, mock, dummy, simulate)"
    echo "3. Validar rangos fisiol√≥gicos (BPM: 30-200, SpO2: 70-100)"
    echo "4. Reemplazar HeartRateDisplay con HeartRate"
    echo "5. Asegurar que todos los datos provienen de sensores reales"
    echo ""
    echo "üí° AYUDA:"
    echo "- Use simulationEradicator.generateCryptographicRandom() en lugar de Math.random()"
    echo "- Implemente validaci√≥n biof√≠sica estricta"
    echo "- Consulte la documentaci√≥n m√©dica en /docs/medical-validation.md"
    echo ""
    echo "‚ùå COMMIT BLOQUEADO - CORRIJA LAS VIOLACIONES ANTES DE CONTINUAR"
    
    # Cleanup
    rm -rf "$temp_dir"
    exit 1
fi

echo "‚úÖ VALIDACI√ìN M√âDICA EXITOSA"
echo "   - Sin simulaciones detectadas"
echo "   - Todos los valores en rangos fisiol√≥gicos"
echo "   - Componentes actualizados"
echo "   - C√≥digo apto para producci√≥n m√©dica"
echo ""
echo "üè• COMMIT APROBADO PARA APLICACI√ìN M√âDICA"

# Cleanup
rm -rf "$temp_dir"
exit 0